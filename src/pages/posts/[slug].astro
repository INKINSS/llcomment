---
import { fetchData } from "../../utils/fetchData";
import { marked } from "marked";
import Layout from "../../layouts/Layout.astro";
import { BackDiscover } from "../../components/common/buttons/BackDiscover";
import { generateSlug } from "../../utils/generateSlug";

// Marcar como no pre-renderizado para que se genere en el servidor
export const prerender = false;

// Obtener el parámetro dinámico
const { slug } = Astro.params;
console.log(`Procesando solicitud para slug: ${slug}`);

let post;
let contentHTML;

try {
  // Recuperar todos los posts
  const posts = await fetchData("posts");
  console.log(`Encontrados ${posts.length} posts totales`);
  
  if (!Array.isArray(posts)) {
    console.error('Los posts no son un array:', posts);
    return Astro.redirect("/404");
  }

  // Buscar el post específico
  post = posts.find((p) => {
    const generatedSlug = generateSlug(p.title);
    console.log(`Comparando ${generatedSlug} con ${slug}`);
    return generatedSlug === slug;
  });

  if (!post) {
    console.log(`No se encontró post para el slug: ${slug}`);
    return Astro.redirect("/404");
  }

  console.log(`Post encontrado:`, post);
  contentHTML = marked(post.content);
} catch (error) {
  console.error(`Error procesando post con slug ${slug}:`, error);
  return Astro.redirect("/404");
}

// Si llegamos aquí, tenemos un post válido
---

<Layout title={`llcomment || ${post.title}`}>
  <article class="flex mt-16 flex-col items-center">
    <h1 class="ssm:text-[1.8rem] text-center sm:text-[2rem] font-bold">
      {post.title}
    </h1>
    <div class="space-x-2">
      <span class="font-semibold">{post.publishDate}</span>
      <span class="font-semibold">
        {post.nickname}
      </span>
    </div>
    <div
      class="my-10 min-w-[60%] prose px-10 ssm:prose-sm md:prose-base"
      set:html={contentHTML}
    />
    <BackDiscover />
  </article>
  <style is:global>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "League Spartan", sans-serif;
    }
  </style>
</Layout>
